<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-g">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hate Speech Detection Bot</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Use Inter font */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom scrollbar for chat log */
        #chat-log::-webkit-scrollbar {
            width: 6px;
        }
        #chat-log::-webkit-scrollbar-track {
            background: #2d3748; /* bg-gray-800 */
        }
        #chat-log::-webkit-scrollbar-thumb {
            background: #4a5568; /* bg-gray-600 */
            border-radius: 3px;
        }
        #chat-log::-webkit-scrollbar-thumb:hover {
            background: #718096; /* bg-gray-500 */
        }
    </style>
</head>
<body class="h-full bg-gray-900 text-gray-100 flex items-center justify-center p-4">

    <!-- Chatbot Container -->
    <div class="flex flex-col h-[95vh] w-full max-w-2xl bg-gray-800 rounded-2xl shadow-2xl overflow-hidden">
        
        <!-- Header -->
        <header class="bg-gray-700 p-4 shadow-md z-10">
            <div class="flex items-center space-x-3">
                <div class="w-3 h-3 bg-red-500 rounded-full"></div>
                <div class="w-3 h-3 bg-yellow-500 rounded-full"></div>
                <div class="w-3 h-3 bg-green-500 rounded-full"></div>
                <h1 class="text-lg font-semibold ml-auto text-gray-200">Hate Speech Detection Bot</h1>
            </div>
        </header>

        <!-- Chat Log -->
        <main id="chat-log" class="flex-1 p-6 space-y-4 overflow-y-auto">
            <!-- Initial Bot Message -->
            <div class="flex justify-start">
                <div class="max-w-xs lg:max-w-md bg-gray-700 p-3 rounded-b-xl rounded-tr-xl shadow">
                    <p class="text-sm">
                        Hello! I am a content moderation bot. Please type a message, and I will classify it as 
                        <span class="font-bold text-green-400">Normal</span>, 
                        <span class="font-bold text-yellow-400">Offensive</span>, or 
                        <span class="font-bold text-red-400">Hate Speech</span>.
                    </p>
                    <p class="text-xs text-gray-400 mt-2">I am connected to a live Python ML model.</p>
                </div>
            </div>
        </main>

        <!-- Input Area -->
        <footer class="bg-gray-700 p-4 shadow-inner">
            <div class="flex space-x-3">
                <input type="text" id="user-input" placeholder="Type your message..." class="flex-1 bg-gray-800 text-gray-100 border border-gray-600 rounded-xl px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500" autocomplete="off">
                <button id="send-button" class="bg-blue-600 text-white font-semibold px-5 py-3 rounded-xl hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors duration-200">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5">
                        <path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.428A1 1 0 009 16.5v-4.5a1 1 0 011-1h.5a1 1 0 011 1v4.5a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.409l-7-14z" />
                    </svg>
                </button>
            </div>
        </footer>
    </div>

    <script>
        // --- DOM Elements ---
        const chatLog = document.getElementById('chat-log');
        const userInput = document.getElementById('user-input');
        const sendButton = document.getElementById('send-button');

        // --- Event Listeners ---
        sendButton.addEventListener('click', handleSendMessage);
        userInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                handleSendMessage();
            }
        });

        /**
         * Handles sending a message: gets user input, displays it, and gets a bot response.
         */
        function handleSendMessage() {
            const message = userInput.value.trim();
            if (message === '') return;

            // 1. Display the user's message
            displayMessage(message, 'user');

            // 2. Clear the input
            userInput.value = '';

            // 3. Get and display the bot's response
            // This now calls our async function
            getBotResponse(message);
        }

        /**
         * Displays a message in the chat log.
         * @param {string} message - The text content of the message.
         * @param {string} sender - 'user' or 'bot'.
         * @param {object} [classification] - Optional classification result object.
         */
        function displayMessage(message, sender, classification = null) {
            const messageElement = document.createElement('div');
            messageElement.classList.add('flex');

            let bubbleClasses = 'p-3 rounded-b-xl shadow max-w-xs lg:max-w-md';
            let content = `<p class="text-sm">${message}</p>`;
            
            if (sender === 'user') {
                messageElement.classList.add('justify-end');
                bubbleClasses += ' bg-blue-600 text-white rounded-tl-xl';
            } else {
                messageElement.classList.add('justify-start');
                
                // --- Apply dynamic styling based on classification ---
                if (classification) {
                    if (classification.class === 0) { // Hate
                        bubbleClasses += ' bg-red-600 text-white rounded-tr-xl';
                        content = `
                            <p class="font-bold text-sm mb-1">Classification: ${classification.label}</p>
                            <p class="text-sm">This content is flagged as hate speech. Confidence: ${(classification.confidence * 100).toFixed(1)}%</p>
                            <p class="text-xs text-red-100 mt-2">Original: "${message}"</p>
                        `;
                    } else if (classification.class === 1) { // Offensive
                        bubbleClasses += ' bg-yellow-500 text-black rounded-tr-xl';
                        content = `
                            <p class="font-bold text-sm mb-1">Classification: ${classification.label}</p>
                            <p class="text-sm">This content is flagged as offensive. Confidence: ${(classification.confidence * 100).toFixed(1)}%</p>
                            <p class="text-xs text-yellow-800 mt-2">Original: "${message}"</p>
                        `;
                    } else { // Neither/Normal
                        bubbleClasses += ' bg-green-600 text-white rounded-tr-xl';
                        content = `
                            <p class="font-bold text-sm mb-1">Classification: ${classification.label}</p>
                            <p class="text-sm">This content appears to be normal speech. Confidence: ${(classification.confidence * 100).toFixed(1)}%</p>
                            <p class="text-xs text-green-100 mt-2">Original: "${message}"</p>
                        `;
                    }
                } else {
                    // Default bot bubble
                    bubbleClasses += ' bg-gray-700 text-gray-100 rounded-tr-xl';
                    content = `<p class="text-sm">${message}</p>`;
                }
            }

            messageElement.innerHTML = `<div class="${bubbleClasses}">${content}</div>`;
            chatLog.appendChild(messageElement);

            // Scroll to the bottom
            chatLog.scrollTop = chatLog.scrollHeight;
        }

        /**
         * Gets a response from the "bot" by calling the Python API.
         * @param {string} message - The user's input message.
         */
        async function getBotResponse(message) {
            // Display a temporary "analyzing" message
            const analyzingElement = document.createElement('div');
            analyzingElement.classList.add('flex', 'justify-start', 'analyzing-bubble');
            analyzingElement.innerHTML = `
                <div class="bg-gray-700 p-3 rounded-b-xl rounded-tr-xl shadow">
                    <p class="text-sm italic text-gray-400">Analyzing...</p>
                </div>
            `;
            chatLog.appendChild(analyzingElement);
            chatLog.scrollTop = chatLog.scrollHeight;
            
            // --- API Call to Python Backend ---
            const API_URL = 'http://127.0.0.1:5000/classify';
            let classification;

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ message: message })
                });

                if (!response.ok) {
                    // Handle server errors (e.g., 500)
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                classification = await response.json();

            } catch (error) {
                console.error("Error calling classification API:", error);
                // Create a special error classification to display
                classification = {
                    class: -1, // Custom error class
                    label: "Connection Error",
                    message: "Could not connect to the Python model. Is the server running? Run `python3 app.py`."
                };
            }
            // ----------------------------------------

            // Remove the "analyzing" message
            const tempBubble = chatLog.querySelector('.analyzing-bubble');
            if (tempBubble) {
                chatLog.removeChild(tempBubble);
            }
            
            // Display the *actual* classification result
            if (classification.class === -1) {
                // Show a special error message in the chat
                displayMessage(classification.message, 'bot');
            } else {
                // Pass the original message to be quoted in the response
                displayMessage(message, 'bot', classification);
            }
        }
        
        // The placeholder classifyText function is removed as it's no longer used.
    </script>
</body>
</html>
